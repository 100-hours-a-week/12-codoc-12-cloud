# /etc/nginx/conf.d/server.conf (dev)

server {
	server_name dev.codoc.cloud;
	charset utf-8;

	# JSON Access Log 적용
	access_log /var/log/nginx/access.log json_combined;
	error_log /var/log/nginx/error.log warn;

	# React 정적 파일
	root /var/www/current;
	index index.html;

	# Let's Encrypt 인증서 갱신용
	location /.well-known/acme-challenge/ {
		root /var/www/certbot;
		allow all;
	}

	# 0. SSE(Streaming) 전용 (반드시 /api/ 보다 위)
	location ~* ^/api/chatbot/messages/\d+/stream$ {
		proxy_pass http://127.0.0.1:8080;

		# 업스트림 HTTP/1.1 고정 (SSE 안정성)
		proxy_http_version 1.1;
		proxy_set_header Connection "";

		# 운영 필수 헤더
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		proxy_set_header X-Request-Id $req_id;
		add_header X-Request-Id $req_id always;

		# 스트리밍 핵심: 버퍼링/캐시/압축 끄기
		proxy_buffering off;
		proxy_cache off;
		gzip off;

		add_header X-Accel-Buffering no;

		proxy_read_timeout 3600s;
		proxy_send_timeout 3600s;
	}

	# 1. Backend API Proxy
	location /api/ {
		proxy_pass http://127.0.0.1:8080;

		proxy_http_version 1.1;
		proxy_set_header Connection "";

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		proxy_set_header X-Request-Id $req_id;
		add_header X-Request-Id $req_id always;

	}

	# 2. AI Proxy (FastAPI)
	location /ai/ {
		proxy_pass http://127.0.0.1:8000/;

		proxy_http_version 1.1;
		proxy_set_header Connection "";

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;

		proxy_connect_timeout 10s;
		proxy_send_timeout 60s;
		proxy_read_timeout 60s;

		proxy_set_header X-Request-Id $req_id;
		add_header X-Request-Id $req_id always;

	}
	location /qdr/ {
		proxy_pass http://127.0.0.1:6333/;

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}


	# Swagger Proxy
	location ^~ /swagger-ui/ {
		proxy_pass http://127.0.0.1:8080;

		proxy_http_version 1.1;
		proxy_set_header Connection "";

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	location = /api/swagger-ui.html {
		proxy_pass http://127.0.0.1:8080;

		proxy_http_version 1.1;
		proxy_set_header Connection "";

		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}

	# 3. 프론트엔드 SPA 라우팅 지원
	location / {
		try_files $uri $uri/ /index.html;
	}

	# 4. 프로필 이미지 업로드 정적 제공
	location /images/ {
		alias /home/ubuntu/uploads/;
		try_files $uri =404;
	}

	# HTTPS 적용 (dev)
	listen 443 ssl;
	ssl_certificate /etc/letsencrypt/live/dev.codoc.cloud/fullchain.pem;
	ssl_certificate_key /etc/letsencrypt/live/dev.codoc.cloud/privkey.pem;
	include /etc/letsencrypt/options-ssl-nginx.conf;
	ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}

# HTTP → HTTPS Redirect (dev)
server {
	listen 80;
	server_name dev.codoc.cloud;

	return 301 https://$host$request_uri;
}
